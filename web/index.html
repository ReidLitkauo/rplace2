<!DOCTYPE html>
<!-- THIS IS A COMPILED FILE. Edit its source files instead if you want changes to persist. -->
<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="/jquery.cookie.js"></script>
		
<title>place</title><script src="/resources/UPNG.js"></script>
		<script type="text/javascript">(function() {
  //###############################################################################
  // Constants
  // Must be kept the same as the ones used by the server

  /////////////////////////////////////////////////////////////////////////////////
  // Websocket message types

  // Server messages
  var ADMN, ANON, AUTH, BANN, BOARD_HEIGHT, BOARD_WIDTH, MSG_C_CHAT, MSG_C_IMAGE, MSG_C_PLACE, MSG_S_BOARDADMN, MSG_S_BOARDANON, MSG_S_BOARDAUTH, MSG_S_BOARDBANN, MSG_S_CHAT, MSG_S_COOLDOWN, MSG_S_UPDATE, MSG_S_USERINFO, PALETTE, PALETTE_INTS, RATELIMIT_SEC, STATUS_BANNED, STATUS_BOTPOS, STATUS_BOTRUN, STATUS_CONNERR, STATUS_COOLDOWN, STATUS_DCONN, STATUS_LINKACCT, STATUS_LOADING, STATUS_PLACETILE, anchorMX, anchorMY, anchorX, anchorY, bot_animateUI, bot_cancel, bot_loop, bot_place, bot_start, canvas_animateUI, canvas_applyPos, canvas_getMouseFromXY, canvas_getRawTransform, canvas_getXYFromMouse, canvas_shouldSkipMouseEvent, chat_close, chat_open, chat_receiveMessages, g_board, g_cooldown, g_pos, g_role, g_text, i, l, l_h, l_imgcc, l_timeout, l_w, l_ws, l_x, l_y, palette_clearUI, popup_close, popup_open, ref, status_get, status_handleCooldown, status_set, ws_paintBoard, ws_send_chat, ws_send_putImage, ws_send_putPixel, ws_updateBoard;

  MSG_S_USERINFO = 0x10;

  MSG_S_BOARDANON = 0x20;

  MSG_S_BOARDAUTH = 0x21;

  MSG_S_BOARDBANN = 0x22;

  MSG_S_BOARDADMN = 0x23;

  MSG_S_UPDATE = 0x30;

  MSG_S_COOLDOWN = 0x40;

  MSG_S_CHAT = 0x50;

  // Client messages
  MSG_C_PLACE = 0xA0;

  MSG_C_IMAGE = 0xA1;

  MSG_C_CHAT = 0xB0;

  /////////////////////////////////////////////////////////////////////////////////
  // User roles
  ANON = 0x80;

  AUTH = 0x81;

  BANN = 0x82;

  ADMN = 0x83;

  /////////////////////////////////////////////////////////////////////////////////
  // Statuses
  STATUS_LOADING = 'loading';

  STATUS_LINKACCT = 'linkacct';

  STATUS_PLACETILE = 'placetile';

  STATUS_CONNERR = 'connerr';

  STATUS_DCONN = 'dconn';

  STATUS_COOLDOWN = 'cooldown';

  STATUS_BANNED = 'banned';

  STATUS_BOTPOS = 'botpos';

  STATUS_BOTRUN = 'botrun';

  /////////////////////////////////////////////////////////////////////////////////
  // Color palette
  PALETTE = [[0x6D, 0x00, 0x1A, 0xFF], [0xBE, 0x00, 0x39, 0xFF], [0xFF, 0x45, 0x00, 0xFF], [0xFF, 0xA8, 0x00, 0xFF], [0xFF, 0xD6, 0x35, 0xFF], [0xFF, 0xF8, 0xB8, 0xFF], [0x00, 0xA3, 0x68, 0xFF], [0x00, 0xCC, 0x78, 0xFF], [0x7E, 0xED, 0x56, 0xFF], [0x00, 0x75, 0x6F, 0xFF], [0x00, 0x9E, 0xAA, 0xFF], [0x00, 0xCC, 0xC0, 0xFF], [0x24, 0x50, 0xA4, 0xFF], [0x36, 0x90, 0xEA, 0xFF], [0x51, 0xE9, 0xF4, 0xFF], [0x49, 0x3A, 0xC1, 0xFF], [0x6A, 0x5C, 0xFF, 0xFF], [0x94, 0xB3, 0xFF, 0xFF], [0x81, 0x1E, 0x9F, 0xFF], [0xB4, 0x4A, 0xC0, 0xFF], [0xE4, 0xAB, 0xFF, 0xFF], [0xDE, 0x10, 0x7F, 0xFF], [0xFF, 0x38, 0x81, 0xFF], [0xFF, 0x99, 0xAA, 0xFF], [0x6D, 0x48, 0x2F, 0xFF], [0x9C, 0x69, 0x26, 0xFF], [0xFF, 0xB4, 0x70, 0xFF], [0x00, 0x00, 0x00, 0xFF], [0x51, 0x52, 0x52, 0xFF], [0x89, 0x8D, 0x90, 0xFF], [0xD4, 0xD7, 0xD9, 0xFF], [0xFF, 0xFF, 0xFF, 0xFF]];

  // Palette as uint32's
  // Generate from PALETTE
  PALETTE_INTS = new Uint32Array(PALETTE.length);

  for (i = l = 0, ref = PALETTE.length; (0 <= ref ? l < ref : l > ref); i = 0 <= ref ? ++l : --l) {
    PALETTE_INTS[i] = PALETTE[i][0] << 24 | PALETTE[i][1] << 16 | PALETTE[i][2] << 8 | PALETTE[i][3] << 0;
  }

  /////////////////////////////////////////////////////////////////////////////////
  // Miscellany
  BOARD_WIDTH = BOARD_HEIGHT = 2000;

  RATELIMIT_SEC = 10;

  //###############################################################################
  // Variables

  // In-memory representation of the board as palette indices
  g_board = new Uint8ClampedArray(BOARD_WIDTH * BOARD_HEIGHT);

  // Canvas positioning
  // To be handled by the position file
  g_pos = null;

  // User role
  g_role = ANON;

  // Cooldown left in seconds
  g_cooldown = null;

  //###############################################################################
  // /web/index/script/text.coffee
  // All text displayed to the user lives in this file.
  // Allows for multiple languages to be used, and to switch languages instantly.
  // In a larger project, this sort of stuff would be stored in a database or
  // something, and would be handled server-side.
  // But meh. This project is small enough for this sort of thing to not be that
  // big of a deal.
  g_text = {
    //###########################################################################
    // Color names
    // In order of appearance on the palette
    'colors': [
      {
        'en': "Darkest Red"
      },
      {
        'en': "Dark Red"
      },
      {
        'en': "Bright Red"
      },
      {
        'en': "Orange"
      },
      {
        'en': "Yellow"
      },
      {
        'en': "Pale Yellow"
      },
      {
        'en': "Dark Green"
      },
      {
        'en': "Green"
      },
      {
        'en': "Light Green"
      },
      {
        'en': "Dark Teal"
      },
      {
        'en': "Teal"
      },
      {
        'en': "Light Teal"
      },
      {
        'en': "Dark Blue"
      },
      {
        'en': "Blue"
      },
      {
        'en': "Light Blue"
      },
      {
        'en': "Indigo"
      },
      {
        'en': "Periwinkle"
      },
      {
        'en': "Lavender"
      },
      {
        'en': "Dark Purple"
      },
      {
        'en': "Purple"
      },
      {
        'en': "Pale Purple"
      },
      {
        'en': "Magenta"
      },
      {
        'en': "Pink"
      },
      {
        'en': "Light Pink"
      },
      {
        'en': "Dark Brown"
      },
      {
        'en': "Brown"
      },
      {
        'en': "Beige"
      },
      {
        'en': "Black"
      },
      {
        'en': "Dark Gray"
      },
      {
        'en': "Gray"
      },
      {
        'en': "Light Gray"
      },
      {
        'en': "White"
      }
    ],
    //###########################################################################
    // Statuses
    // Shown to the user on the status bar at the bottom
    'status': {
      /////////////////////////////////////////////////////////////////////////
      // Loading
      // Shown when page is initializing, before MSG_S_BOARD* received
      'loading': {
        'en': "Loading..."
      },
      
      /////////////////////////////////////////////////////////////////////////
      // Link Account
      // CTA shown to anons, request linking a Reddit account to use the site
      'linkacct': {
        'en': "Link your Reddit account"
      },
      
      /////////////////////////////////////////////////////////////////////////
      // Place Tile
      // Shown to authorized/admin users, pulls up the color palette
      'placetile': {
        'en': "Place a tile"
      },
      
      /////////////////////////////////////////////////////////////////////////
      // Connection Error
      // Shown when the websocket encounters an error
      'connerr': {
        'en': "Couldn't connect!"
      },
      
      /////////////////////////////////////////////////////////////////////////
      // Disconnection
      // Shown when the user is disconnected from the server
      'dconn': {
        'en': "Disconnected"
      },
      
      /////////////////////////////////////////////////////////////////////////
      // Banned
      // Shown to banned users, prohibits all tile placement
      'banned': {
        'en': "Your account is banned"
      },
      /////////////////////////////////////////////////////////////////////////
      // Bot Positioning
      // Shown to users who are positioning an image for the bot
      // Should be an invitation to place the image
      'botpos': {
        'en': "Place image"
      },
      
      /////////////////////////////////////////////////////////////////////////
      // Bot Running
      // Shown when the bot is actively placing images
      'botrun': {
        'en': "Placing image..."
      }
    },
    //###########################################################################
    // Account Validation Errors
    // Shown as a popup to users when they link their Reddit account
    'validate': {
      /////////////////////////////////////////////////////////////////////////
      // Server Error
      // Shown to user when something funky happens on my site
      'servererror': {
        'en': "This website encountered a technical error while trying to link your account. Please reach out via Discord, or try again later."
      },
      /////////////////////////////////////////////////////////////////////////
      // Reddit Error
      // Shown to user when something funky happens on Reddit's end
      'redditerror': {
        'en': "Reddit ran into a problem while trying to link your account. Please reach out via Discord, or try again later."
      },
      /////////////////////////////////////////////////////////////////////////
      // User Banned
      // An admin has banned this user
      'userbanned': {
        'en': "Your account is banned from this platform. If you feel this is in error, please reach out to an admin on our Discord server."
      },
      /////////////////////////////////////////////////////////////////////////
      // Below Threshold
      // Account does not meet minimum age/karma requirements
      'belowthreshold': {
        'en': "Your account does not meet our minimum age and karma requirements. Please use Reddit a bit more, and try again later."
      },
      /////////////////////////////////////////////////////////////////////////
      // User Denied
      // The user did not allow the app access to their account
      // Try to make them feel better, be honest about what we do, and
      // encourage them to let us know if they have any concerns
      'userdenied': {
        'en': "We only need access to your username, account age, and total karma in order to link your account &ndash; not your post/comment history or anything else. If you have concerns about our account linkage flow or what data we collect, please reach out to us via Discord."
      }
    }
  };

  //###############################################################################
  // Position declaration
  g_pos = {
    /////////////////////////////////////////////////////////////////////////////
    // Position variables

    // X/Y coords of screen center
    x: null,
    y: null,
    // Floored versions of coords
    xf: null,
    yf: null,
    // Coordinate constraints
    // min <= x/y < max
    xmin: 0,
    ymin: 0,
    xmax: BOARD_WIDTH,
    ymax: BOARD_HEIGHT,
    // Zoom index and zoom level
    zi: null,
    zl: null,
    // Valid values for zoom level
    zooms: [0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2, 3, 5, 10],
    /////////////////////////////////////////////////////////////////////////////
    // Position manipulation
    set: function(x, y, zi) {
      // Check for null values, which indicate to not change that coord
      if (x == null) {
        x = this.x;
      }
      if (y == null) {
        y = this.y;
      }
      if (zi == null) {
        zi = this.zi;
      }
      // Range checks and other validation
      if (x < this.xmin) {
        x = this.xmin;
      }
      if (y < this.ymin) {
        y = this.ymin;
      }
      if (x >= this.xmax) {
        x = this.xmax * (1 - Number.EPSILON);
      }
      if (y >= this.ymax) {
        y = this.ymax * (1 - Number.EPSILON);
      }
      zi = Math.floor(zi);
      if (zi < 0) {
        zi = 0;
      }
      if (zi >= this.zooms.length) {
        zi = this.zooms.length - 1;
      }
      
      // Set values
      this.x = x;
      this.y = y;
      this.xf = Math.floor(x);
      this.yf = Math.floor(y);
      this.zi = zi;
      this.zl = this.zooms[zi];
      // Update view with new coords
      canvas_applyPos();
      return this;
    },
    add: function(x, y, zi) {
      return this.set(x + this.x, y + this.y, zi + this.zi);
    },
    /////////////////////////////////////////////////////////////////////////////
    // Position constraints
    setMin: function(x = 0, y = 0) {
      // Perform min adjustment
      this.xmin = x;
      this.ymin = y;
      // Reposition if necessary
      return this.set(this.x, this.y, this.zi);
    },
    setMax: function(x = BOARD_WIDTH, y = BOARD_HEIGHT) {
      // Perform max adjustment
      this.xmax = x;
      this.ymax = y;
      // Reposition if necessary
      return this.set(this.x, this.y, this.zi);
    }
  };

  //###############################################################################
  // Initialization
  $(function() {
    var ref1, ref2, ref3, x, y, zi;
    // Grab position data from cookie, set to defaults if needed
    x = (ref1 = $.cookie('posx')) != null ? ref1 : 1000.5;
    y = (ref2 = $.cookie('posy')) != null ? ref2 : 1000.5;
    zi = (ref3 = $.cookie('poszi')) != null ? ref3 : 6;
    // Initialize position
    return g_pos.set(x, y, zi);
  });

  //###############################################################################
  // Global variables

  // Anchor X and Y coordinates, established when clicking down on the canvas
  anchorX = null;

  anchorY = null;

  // Corresponding mouse coordinates for those X and Y coords
  anchorMX = null;

  anchorMY = null;

  //###############################################################################
  // Helper functions

  /////////////////////////////////////////////////////////////////////////////////
  // Determine if we should skip this mouse event
  // Necessary since all events are attached to the BODY
  canvas_shouldSkipMouseEvent = function(e) {
    // A popup is open, let that take precedence
    if ($('.popup:not(.-hidden)').length) {
      return true;
    }
    // Source is the chat box, don't bother with that
    if ($(e.target).add($(e.target).parents()).is('.chat-parent')) {
      return true;
    }
    // Passed all checks, continue
    return false;
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Get raw transformation values
  // txp, typ: transform along x/y as percentage
  // sf: scale factor
  // I did a LOT of experimentation to arrive at these numbers, and they seem to
  // work just fine. I don't have a mathematical proof behind these though...
  canvas_getRawTransform = function(x, y, z) {
    var sf, txp, typ;
    txp = (100.0 / 2000.0) * x;
    typ = (100.0 / 2000.0) * y;
    sf = z * 10.0;
    return {
      txp: txp,
      typ: typ,
      sf: sf
    };
  };

  /////////////////////////////////////////////////////////////////////////////////
  // From a raw mouse coordinate, grab cooresponding x/y coord on the canvas
  canvas_getXYFromMouse = function(mx, my) {
    var bb, invalid, x, xc, xp, y, yc, yp;
    // Grab canvas bounding box, this will take transforms into consideration
    bb = $('canvas.place')[0].getBoundingClientRect();
    // Re-orient mouse coordinates to use top-left of canvas as origin
    xc = mx - bb.x;
    yc = my - bb.y;
    // Scale according to canvas dimensions
    xp = xc / bb.width;
    yp = yc / bb.height;
    // We now have coordinates as a percentage of canvas width/height
    // Multiply by number of pixels to get final result
    x = xp * BOARD_WIDTH;
    y = yp * BOARD_HEIGHT;
    // Scan for invalid outputs
    invalid = x < 0 || y < 0 || x >= BOARD_WIDTH || y >= BOARD_HEIGHT;
    return {
      
      // Success
      x: x,
      y: y,
      invalid: invalid
    };
  };

  /////////////////////////////////////////////////////////////////////////////////
  // From an x/y coord on the canvas, grab cooresponding raw mouse coordinate
  canvas_getMouseFromXY = function(x, y) {
    var bb, mx, my, xc, xp, yc, yp;
    // Grab canvas bounding box, this will take transforms into consideration
    bb = $('canvas.place')[0].getBoundingClientRect();
    // Get coords as percentage of canvas TODO
    xp = x / BOARD_WIDTH;
    yp = y / BOARD_HEIGHT;
    // Scale according to canvas dimensions
    xc = xp * bb.width;
    yc = yp * bb.height;
    // Re-orient mouse coordinates to correct for top-left of canvas
    mx = xc + bb.x;
    my = yc + bb.y;
    return {
      // Return
      mx: mx,
      my: my
    };
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Transform the canvas to reflect being positioned
  // at the given X,Y coord with the given zoom.
  canvas_applyPos = function() {
    var t;
    //===========================================================================
    // Move the canvas parent to the correct spot

    // Grab raw transform values
    t = canvas_getRawTransform(g_pos.x, g_pos.y, g_pos.zl);
    // Format correctly and apply to element designed to handle these transforms
    // Other DOM elements will resize and move appropriately
    $('canvas.place').css('transform', `scale(${t.sf}) translate(-${t.txp}%, -${t.typ}%)`);
    //===========================================================================
    // Update the XYZ UI element at the top
    return $('.panel.pos-zoom').text(`(${g_pos.xf},${g_pos.yf}) ${g_pos.zl}x`);
  };

  //===========================================================================
  // Miscellany

  // Prevent artifacting/smearing
  // https://stackoverflow.com/q/8840580
  // TODO nothing worked :(

  /////////////////////////////////////////////////////////////////////////////////
  // Animate the pixel selection reticule and other canvas-bound UI elements
  canvas_animateUI = function() {
    var br, tl;
    //===========================================================================
    // Pixel selection reticule

    // Retrieve coordinates for top-left and bottom-right
    tl = canvas_getMouseFromXY(g_pos.xf, g_pos.yf);
    br = canvas_getMouseFromXY(1 + g_pos.xf, 1 + g_pos.yf);
    // As simple as moving the selction SVG's parent to the correct spot.
    $('.reticule').css({
      top: tl.my + 'px',
      left: tl.mx + 'px',
      width: (br.mx - tl.mx) + 'px',
      height: (br.my - tl.my) + 'px'
    });
    //===========================================================================
    // Cleanup

    // DO IT AGAIN
    return window.requestAnimationFrame(canvas_animateUI);
  };

  //###############################################################################
  // Initialization
  $(function() {
    // Set initial position
    canvas_applyPos();
    // Begin animation loop
    return window.requestAnimationFrame(canvas_animateUI);
  });

  //###############################################################################
  // Event handling
  $(function() {
    /////////////////////////////////////////////////////////////////////////////
    // Process click-and-drag

    //===========================================================================
    // Mousedown: Establish anchor point
    $('body').on('mousedown', function(e) {
      if (canvas_shouldSkipMouseEvent(e) || $(e.target).add($(e.target).parents()).is('.palette, .panel')) {
        anchorX = null;
        anchorY = null;
        anchorMX = null;
        return anchorMY = null;
      } else {
        // Remove transition smoothing, we want to be responsive
        $('canvas.place').removeClass('smooth-animation');
        // Establishing an anchor point
        anchorX = g_pos.x;
        anchorY = g_pos.y;
        anchorMX = e.originalEvent.x;
        return anchorMY = e.originalEvent.y;
      }
    });
    
    //===========================================================================
    // Mouseup: Re-apply animation smoothing
    $('body').on('mouseup', function(e) {
      //if canvas_shouldSkipMouseEvent(e) then return

      // Re-apply animation smoothing
      return $('canvas.place').addClass('smooth-animation');
    });
    
    //===========================================================================
    // Click: Open pallete and set coords
    $('body').on('click', function(e) {
      var coords;
      if (canvas_shouldSkipMouseEvent(e)) {
        return;
      }
      // Only applies if click's mousedown coords were same as mouseup coords
      if (e.originalEvent.x === anchorMX && e.originalEvent.y === anchorMY) {
        // Obtain pixel that was clicked
        coords = canvas_getXYFromMouse(anchorMX, anchorMY);
        console.log(coords);
        if (!coords.invalid) {
          g_pos.set(Math.floor(coords.x) + 0.5, Math.floor(coords.y) + 0.5, null);
          // Also show the palette if we can
          if (status_get() === 'placetile') {
            return $('.palette').removeClass('-hidden');
          }
        }
      }
    });
    //===========================================================================
    // Mousemove: Move canvas using anchor as reference
    $('body').on('mousemove', function(e) {
      var moveXpx, moveXratio, moveYpx, moveYratio, realsizeX, realsizeY;
      
      //if canvas_shouldSkipMouseEvent(e) then return

      // Only move if a mouse button is pressed and anchor was set
      if (e.buttons && anchorX !== null) {
        // How far away from the anchor is the mouse now?
        moveXpx = e.originalEvent.x - anchorMX;
        moveYpx = e.originalEvent.y - anchorMY;
        
        // Get the size of the element in pixels
        realsizeX = $('canvas.place').width();
        realsizeY = $('canvas.place').height();
        
        // Convert these coordinates in client space into a percentage of
        // the element. What percent of the element have we traversed since
        // mousedown?
        moveXratio = moveXpx / (realsizeX * 10.0 * g_pos.zl);
        moveYratio = moveYpx / (realsizeY * 10.0 * g_pos.zl);
        // Set position appropriately
        return g_pos.set(anchorX - (moveXratio * BOARD_WIDTH), anchorY - (moveYratio * BOARD_HEIGHT), null);
      }
    });
    /////////////////////////////////////////////////////////////////////////////////
    // Process scroll wheel
    return $('body').on('wheel', function(e) {
      var coord, zl_add;
      if (canvas_shouldSkipMouseEvent(e)) {
        return;
      }
      // Determine zoom level to add from event
      zl_add = 0;
      if (e.originalEvent.deltaY < 0) {
        zl_add = +1;
      }
      if (e.originalEvent.deltaY > 0) {
        zl_add = -1;
      }
      // Apply zoom to position
      g_pos.add(0, 0, zl_add);
      // Remove smoothing
      $('canvas.place').removeClass('smooth-animation');
      // Render the canvas zoom
      canvas_applyPos();
      // Re-establish anchor point if we're holding down a mouse button
      if (e.buttons) {
        coord = canvas_getXYFromMouse(e.originalEvent.x, e.originalEvent.y);
        anchorX = g_pos.x;
        anchorY = g_pos.y;
        anchorMX = e.originalEvent.x;
        anchorMY = e.originalEvent.y;
      }
      if (!e.buttons) {
        return $('canvas.place').addClass('smooth-animation');
      }
    });
  });

  
  //###############################################################################
  // Helper functions

  /////////////////////////////////////////////////////////////////////////////////
  // Set status
  status_set = function(s, timeleft = RATELIMIT_SEC) {
    //===========================================================================
    // Common preprocessing

    // Set dataset attribute right away
    $('.panel.status')[0].dataset.mode = s;
    //===========================================================================
    // Special considerations

    // Do we need to widen the status bar?
    if (s === STATUS_LINKACCT || s === STATUS_BANNED) {
      $('.panel.status').addClass('wide');
    } else {
      $('.panel.status').removeClass('wide');
    }
    
    // Special handling for cooldown status
    if (s === STATUS_COOLDOWN) {
      $('.panel.status').html("<img class='timeleft' src='/timer.svg' /> <div class='timeleft'></div>");
      status_handleCooldown(timeleft);
      return;
    }
    //===========================================================================
    // Show status to user

    // TODO allow for multiple languages
    return $('.panel.status').text(g_text.status[s]['en']);
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Retrieve status
  status_get = function() {
    return $('.panel.status')[0].dataset.mode;
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Show cooldown message to user
  status_handleCooldown = function(cooldown = RATELIMIT_SEC) {
    var interval, intervalfn;
    g_cooldown = cooldown;
    intervalfn = function() {
      var h, hs, m, ms, s, ss;
      // No point in continuing if status has changed since last update
      if (status_get() !== STATUS_COOLDOWN) {
        clearTimeout(interval);
        return;
      }
      // Clear the interval if we don't need it anymore
      if (g_cooldown <= 0) {
        g_cooldown = null;
        $('.panel.status .timeleft').html('');
        clearTimeout(interval);
        status_set(STATUS_PLACETILE);
        return;
      }
      
      // Determine hours/minutes/seconds left
      h = Math.floor(g_cooldown / 3600);
      m = Math.floor((g_cooldown % 3600) / 60);
      s = Math.floor(g_cooldown % 60);
      // Add padding zeroes if needed
      hs = (h < 10 ? "0" : "") + h;
      ms = (m < 10 ? "0" : "") + m;
      ss = (s < 10 ? "0" : "") + s;
      
      // Display the properly-formatted time left
      $('.panel.status .timeleft').html(`${hs}:${ms}:${ss}`);
      // Decrement our time left
      return g_cooldown--;
    };
    
    // Set the interval
    interval = setInterval(intervalfn, 1000);
    return intervalfn();
  };

  //###############################################################################
  // Initialization
  $(function() {
    // Set initial status
    return status_set(STATUS_LOADING);
  });

  //###############################################################################
  // Event handling
  $(function() {
    /////////////////////////////////////////////////////////////////////////////
    // Clicked on status bar: Do whatever is most appropriate
    return $('.panel.status').on('click', function(e) {
      switch (status_get()) {
        //when STATUS_LOADING

          //===================================================================
        // Link account: Start reddit account linkage webflow
        case STATUS_LINKACCT:
          return window.open(document.location.protocol + "//" + document.location.host + "/endpoint/link-reddit-account", "_blank").focus();
        //===================================================================
        // Place tile: Show the palette
        case STATUS_PLACETILE:
          g_pos.set(g_pos.xf + 0.5, g_pos.yf + 0.5, null);
          return $('.palette').removeClass('-hidden');
        //===================================================================
        // Bot positioning: Place the image
        case STATUS_BOTPOS:
          // Start the bot normally if we're a normal user
          if (g_role === AUTH) {
            bot_start();
          }
          // Admins get access to insta-place
          if (g_role === ADMN) {
            return bot_place();
          }
          break;
        //===================================================================
        // Bot running: Stop the bot
        case STATUS_BOTRUN:
          return bot_cancel();
      }
    });
  });

  //###############################################################################
  // Helper functions

  /////////////////////////////////////////////////////////////////////////////////
  // Clean and hide the palette UI
  palette_clearUI = function() {
    // Disable submit button
    $('.palette form.submit button').attr('disabled', 'disabled');
    // De-select all colors
    $('.palette .colors .color').removeClass('selected');
    // Clear placement reticule color
    $('.reticule').css('background-color', "transparent");
    // And hide the UI
    return $('.palette').addClass('-hidden');
  };

  //###############################################################################
  // Initialization
  $(function() {
    var k, ref1, ref2, results, rgb_bdr, rgb_bg, v;
/////////////////////////////////////////////////////////////////////////////
// Create all color options from palette constant
    results = [];
    for (k in PALETTE) {
      v = PALETTE[k];
      // Grab background color from palette
      rgb_bg = `rgb(${v[0]},${v[1]},${v[2]})`;
      // Same as background color, except for white, which has black border
      rgb_bdr = ((v[0] === (ref2 = v[1]) && ref2 === (ref1 = v[2])) && ref1 === 0xFF) ? "black" : rgb_bg;
      // Append correctly-formatted element
      // The data-index is a special tool that will help us later ;3
      results.push($('.palette .colors').append($(`<div data-index='${k}' class='color' style='background-color: ${rgb_bg}; border-color: ${rgb_bdr};'></div>`)));
    }
    return results;
  });

  //###############################################################################
  // Event handling
  $(function() {
    /////////////////////////////////////////////////////////////////////////////
    // Clicked a color: Mark it as selected
    $('.palette .colors .color').on('click', function(e) {
      var c;
      // Ensure only the selected color is pressed
      $('.palette .colors .color').removeClass('selected');
      $(e.target).addClass('selected');
      // Change placement reticule to match selected color
      c = PALETTE[e.target.dataset.index];
      $('.reticule').css('background-color', `rgb( ${c[0]}, ${c[1]}, ${c[2]} )`);
      // Enable the submit button
      return $('.palette form.submit button')[0].removeAttribute('disabled');
    });
    
    /////////////////////////////////////////////////////////////////////////////
    // Clicked cancel button: Remove color selection and hide palette UI
    $('.palette form.cancel').on('submit', function(e) {
      e.preventDefault();
      palette_clearUI();
      return false;
    });
    /////////////////////////////////////////////////////////////////////////////
    // Clicked submit button: Send pixel to server and hide palette UI
    // Submit placement
    return $('.palette form.submit').on('submit', function(e) {
      e.preventDefault();
      //=======================================================================
      // Send a pixel-placement message
      ws_send_putPixel(g_pos.xf, g_pos.yf, $('.palette .colors .color.selected')[0].dataset.index);
      //=======================================================================
      // Update the UI

      // Show appropriate follow-up status
      if (g_role === ADMN) {
        status_set(STATUS_PLACETILE);
      }
      if (g_role === AUTH) {
        status_set(STATUS_COOLDOWN);
      }
      // Clean the palette UI
      palette_clearUI();
      return false;
    });
  });

  //###############################################################################
  // Helper Functions

  /////////////////////////////////////////////////////////////////////////////////
  // Open a popup
  popup_open = function(popup, extra = null) {
    //===========================================================================
    // Special handling: Validation popup
    // Show the relevant account validation message to the user
    if (popup === "validate") {
      // The validate message type to grab is stored in the extra parameter

      // Make sure we have a valid validate message
      // If not, then do nothing
      if ((extra == null) || !(extra in g_text.validate)) {
        return;
      }
      
      // If we do, then show the text of that message
      // TODO make language-independent
      $('.popup.validate .text').html(g_text.validate[extra]['en']);
    }
    //===========================================================================
    // General post-processing

    // Close all open popups, only have one open at a time
    popup_close();
    // Show the requested popup
    return $(`.popup.${popup}, .popup-grayout`).removeClass('-hidden');
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Close all popups
  popup_close = function() {
    // Hide all popups and the grayout backdrop
    return $('.popup, .popup-grayout').addClass('-hidden');
  };

  //###############################################################################
  // Initialization
  $(function() {
    var query, validate_msg;
    // Parser for the URL's query string
    query = new URLSearchParams(window.location.search);
    // Check if we have a validation message to show to the user
    if ((validate_msg = query.get('validate')) != null) {
      return popup_open('validate', validate_msg);
    }
  });

  //###############################################################################
  // Event handling
  $(function() {
    /////////////////////////////////////////////////////////////////////////////
    // Open popups

    //===========================================================================
    // About popup
    $('.panel.button.about').on('click', function(e) {
      return popup_open('about');
    });
    
    /////////////////////////////////////////////////////////////////////////////
    // Close popups

    // TODO add close buttons
    return $('body').on('click', function(e) {
      // Close popups when user clicks outside of them
      if ($(e.target).add($(e.target).parents()).is('.popup-grayout')) {
        return popup_close();
      }
      // Close popups when user clicks on a cancel button
      if ($(e.target).add($(e.target).parents()).is('button.cancel')) {
        return popup_close();
      }
    });
  });

  //###############################################################################
  // Helper functions

  /////////////////////////////////////////////////////////////////////////////////
  // Open chat
  chat_open = function() {
    // Reveal the chat side panel
    $('.chat-parent').removeClass('-hidden');
    // Focus the chat input
    return $('.chat-parent .chat-send input').focus();
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Close chat
  chat_close = function() {
    return $('.chat-parent').addClass('-hidden');
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Receive chat messages
  chat_receiveMessages = function(raw) {
    var chatlog, len, m, msgs, n, scroll_lock;
    //===========================================================================
    // Extract chats from raw

    // Did a lot of fiddling in the JS console to get this juuuuust right
    // - Make a typed array out of the buffer behind the message
    // - Chop off the first byte and run the rest through a UTF8 decoder
    // - Parse the resulting text into a JS object
    msgs = JSON.parse(new TextDecoder().decode(new Uint8Array(raw.buffer).slice(1)));
    // We now have an array of messages to append,
    // with the oldest at index 0 and newest at the end.

    //===========================================================================
    // Store scroll position

    // Store a reference to the chat log for convenience/speed
    chatlog = $('.chat-log')[0];
    // Determine if we're scrolled to the bottom
    // https://stackoverflow.com/a/876134
    scroll_lock = chatlog.scrollTop === (chatlog.scrollHeight - chatlog.offsetHeight);
//===========================================================================
// Append messages to the chat log

    // Cycle through each message
    for (n = 0, len = msgs.length; n < len; n++) {
      m = msgs[n];
      // If this message already exists in the chat log, skip it
      if ($(`.chat-log .msg[id=${m.id}]`).length) {
        continue;
      }
      // If this message's author also wrote the most recent message present,
      // then append to the last message group
      if ($('.chat-log .msg-group:last-child .user').text() === m.user) {
        $('.chat-log .msg-group:last-child').append($(`<div class='msg'>${m.msg}</div>`));
      } else {
        // Otherwise, create a new group with the message
        $('.chat-log').append($(`<div class='msg-group'> <div class='user'>${m.user}</div> <div class='msg'>${m.msg}</div> </div>`));
      }
    }
    
    //===========================================================================
    // Keep scroll lock if already set
    if (scroll_lock) {
      return chatlog.scrollTop = chatlog.scrollHeight - chatlog.offsetHeight;
    }
  };

  //###############################################################################
  // Event handling
  $(function() {
    /////////////////////////////////////////////////////////////////////////////
    // Send a message
    $('.chat-parent form.chat-send').on('submit', function(e) {
      e.preventDefault();
      ws_send_chat($('.chat-parent form.chat-send input').val());
      $('.chat-parent form.chat-send input').val('');
      return false;
    });
    /////////////////////////////////////////////////////////////////////////////
    // Open and close
    $('.panel.button.chat').on('click', function(e) {
      return chat_open();
    });
    return $('.chat-parent button.cancel').on('click', function(e) {
      return chat_close();
    });
  });

  //###############################################################################
  // Globals

  // The websocket
  l_ws = null;

  //###############################################################################
  // Helpful functions

  /////////////////////////////////////////////////////////////////////////////////
  // Pass a DataView into a MSGTYPE_HBOARD* message, and this function will
  // render that message onto the board.
  ws_paintBoard = function(wsdv) {
    var cc, cx, id, j, n, o, ref1;
    // Overwrite our in-memory board state
    g_board = new Uint8ClampedArray(wsdv.buffer.slice(1, wsdv.buffer.length));
    // Grab canvas context and image data
    cx = $('canvas.place')[0].getContext('2d');
    id = cx.getImageData(0, 0, BOARD_WIDTH, BOARD_HEIGHT);
// Process each color code passed to us
    for (i = n = 0, ref1 = BOARD_WIDTH * BOARD_HEIGHT; (0 <= ref1 ? n < ref1 : n > ref1); i = 0 <= ref1 ? ++n : --n) {
      cc = wsdv.getUint8(i + 1);
      for (j = o = 0; o < 4; j = ++o) {
        id.data[(i * 4) + j] = PALETTE[cc][j];
      }
    }
    
    // Put image data
    return cx.putImageData(id, 0, 0);
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Pass a DataView into a MSG_S_UPDATE message, and this function will
  // render the update to the board.
  ws_updateBoard = function(wsdv) {
    var c, cx, id, n, pack, ref1, x, y;
    // Grab canvas context and image data
    cx = $('canvas.place')[0].getContext('2d');
    id = cx.getImageData(0, 0, BOARD_WIDTH, BOARD_HEIGHT);
// Process each color code passed to us
    for (i = n = 1, ref1 = wsdv.byteLength; n < ref1; i = n += 4) {
      // Grab packed pixel
      pack = wsdv.getUint32(i);
      // Unpack pixel
      x = Math.floor((pack >> 8) % BOARD_WIDTH);
      y = Math.floor((pack >> 8) / BOARD_WIDTH);
      c = Math.floor((pack >> 0) & 0xFF);
      // Update in-memory board
      g_board[x + y * BOARD_WIDTH] = c;
      // Update canvas
      id.data.set(PALETTE[c], 4 * (x + (y * BOARD_WIDTH)));
    }
    // Put image data
    return cx.putImageData(id, 0, 0);
  };

  //###############################################################################
  // Message sending functions

  //===============================================================================
  // Send a "place pixel" message
  ws_send_putPixel = function(x, y, c) {
    var ab, dv, pixel;
    //-----------------------------------------------------------------------
    // Initialization

    // Message variables
    ab = new ArrayBuffer(5);
    dv = new DataView(ab);
    //-----------------------------------------------------------------------
    // Header

    // Message type
    dv.setUint8(0, MSG_C_PLACE);
    //-----------------------------------------------------------------------
    // Payload

    // Create a packed pixel with color and position
    pixel = ((x + (y * BOARD_WIDTH)) << 8) | c;
    // Plop the packed pixel in place
    dv.setUint32(1, pixel);
    //-----------------------------------------------------------------------
    // Send
    return l_ws.send(dv);
  };

  //===============================================================================
  // Send a "place image" message
  // ADMN use only, server rejects these messages if sent by other roles
  ws_send_putImage = function(x, y, w, h, ccs) {
    var ab, dv, ua;
    //-----------------------------------------------------------------------
    // Initialization

    // Message variables
    ab = new ArrayBuffer(9 + (w * h));
    dv = new DataView(ab);
    ua = new Uint8Array(ab);
    //-----------------------------------------------------------------------
    // Header

    // Message type
    dv.setUint8(0, MSG_C_IMAGE);
    // Set x/y/w/h
    dv.setUint16(1, x);
    dv.setUint16(3, y);
    dv.setUint16(5, w);
    dv.setUint16(7, h);
    //-----------------------------------------------------------------------
    // Payload
    ua.set(ccs, 9);
    //-----------------------------------------------------------------------
    // Send
    return l_ws.send(dv);
  };

  //===============================================================================
  // Send a chat message
  ws_send_chat = function(msg) {
    var ab, dv, msg_encoded, ua;
    //-----------------------------------------------------------------------
    // Initialization

    // Convert the message to a byte array
    // Gotta do this first to know how long the message ought to be
    // TextEncoder defaults to UTF8
    msg_encoded = new TextEncoder().encode(msg);
    // Create final message
    ab = new ArrayBuffer(3 + msg_encoded.length);
    dv = new DataView(ab);
    ua = new Uint8Array(ab);
    //-----------------------------------------------------------------------
    // Header

    // Message type
    dv.setUint8(0, MSG_C_CHAT);
    // Message language
    ua.set(new TextEncoder().encode('en'), 1);
    //-----------------------------------------------------------------------
    // Payload

    // Set message payload as the encoded message we made earlier
    ua.set(msg_encoded, 3);
    //-----------------------------------------------------------------------
    // Send
    return l_ws.send(dv);
  };

  //###############################################################################
  // Initialization
  $(function() {
    var wsurl;
    /////////////////////////////////////////////////////////////////////////////
    // Build out websocket URL

    // Start with protocol, match to window
    wsurl = document.location.protocol === 'https:' ? 'wss:' : 'ws:';
    // Add current host, no need to hardcode this in
    // This plays nice with the server's CSRF protection
    wsurl += "//" + document.location.host + "/ws";
    // Append session cookie if we have one
    if ($.cookie('session')) {
      wsurl += "?session=" + $.cookie('session');
    }
    /////////////////////////////////////////////////////////////////////////////
    // Establish Websocket connection
    return l_ws = new WebSocket(wsurl);
  });

  //###############################################################################
  // Event handling
  $(function() {
    /////////////////////////////////////////////////////////////////////////////
    // Handle errors and closure
    l_ws.onerror = l_ws.onclose = function(e) {
      return status_set(STATUS_DCONN);
    };
    
    /////////////////////////////////////////////////////////////////////////////
    // Handle messages
    return l_ws.onmessage = function({data}) {
      //=======================================================================
      // Initialization

      // Why does this return a promise :(
      return data.arrayBuffer().then(function(raw) {
        var d, msgtype;
        // Grab a data view of the message and find the message type
        d = new DataView(raw);
        msgtype = d.getUint8(0);
        // Process message
        switch (msgtype) {
          //---------------------------------------------------------------
          // User information message
          case MSG_S_USERINFO:
            console.log(d);
            break;
          //---------------------------------------------------------------
          // Board initialization: Unauthenticated user
          case MSG_S_BOARDANON:
            // Tell user to link account to proceed
            status_set(STATUS_LINKACCT);
            break;
          
            //---------------------------------------------------------------
          // Board initialization: Standard authenticated user
          case MSG_S_BOARDAUTH:
            // Set role
            g_role = AUTH;
            // Show appropriate buttons
            $('.panel.button.chat, .panel.button.settings, .panel.button.bot').removeClass('-hidden');
            // If we're not rate-limited, allow for pixel placement
            if (status_get() !== STATUS_COOLDOWN) {
              status_set(STATUS_PLACETILE);
            }
            break;
          //---------------------------------------------------------------
          // Board initialization: Admin user
          case MSG_S_BOARDADMN:
            // Set role
            g_role = ADMN;
            // Remove rate limiting
            RATELIMIT_SEC = 0;
            // Show appropriate buttons
            $('.panel.button.chat, .panel.button.settings, .panel.button.bot, .panel.button.admin').removeClass('-hidden');
            // Set status
            status_set(STATUS_PLACETILE);
            break;
          //---------------------------------------------------------------
          // Board initialization: Banned user
          case MSG_S_BOARDBANN:
            // Set role
            g_role = BANN;
            // Tell the user they suk
            status_set(STATUS_BANNED);
            break;
          
            //---------------------------------------------------------------
          // Chat message
          case MSG_S_CHAT:
            chat_receiveMessages(d);
            break;
          
            //---------------------------------------------------------------
          // Board update
          case MSG_S_UPDATE:
            ws_updateBoard(d);
            break;
          
            //---------------------------------------------------------------
          // Cooldown message
          case MSG_S_COOLDOWN:
            status_set(STATUS_COOLDOWN, d.getUint32(1));
        }
        
        //-------------------------------------------------------------------
        // Board initialization: Any user

        // Multiple message types tell us to paint the board
        // Since you can't meet two cases in a single switch ...
        // Process board drawing here.
        if (msgtype === MSG_S_BOARDADMN || msgtype === MSG_S_BOARDANON || msgtype === MSG_S_BOARDAUTH || msgtype === MSG_S_BOARDBANN) {
          return ws_paintBoard(d);
        }
      });
    };
  });

  //###############################################################################
  // Globals

  // Raw image color code data
  l_imgcc = null;

  // Image position
  l_x = l_y = 0;

  // Image width and height
  l_w = l_h = 0;

  // Bot timeout
  l_timeout = null;

  // TODO add transparency skip
  // TODO restore full pos movement when bot start
  // TODO fix status upon bot start

  //###############################################################################
  // Helper functions

  /////////////////////////////////////////////////////////////////////////////////
  // Start the bot's main loop
  bot_start = function() {
    // Empty bot canvas, but keep the border
    $('canvas.bot')[0].getContext('2d').clearRect(0, 0, l_w, l_h);
    // Show pixel selection reticule
    $('.reticule').removeClass('-hidden');
    // Reset min/max allowable position to allow free roaming
    g_pos.setMin().setMax();
    // Set position
    l_x = g_pos.xf - Math.floor(l_w / 2);
    l_y = g_pos.yf - Math.floor(l_h / 2);
    // Begin main bot loop
    l_timeout = window.setTimeout(bot_loop, g_cooldown != null ? 1000 * g_cooldown : 0);
    // Set cooldown to max
    g_cooldown = RATELIMIT_SEC;
    // Set appropriate status
    return status_set(STATUS_BOTRUN);
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Bot main loop
  bot_loop = function() {
    var bi, ci, n, o, ref1, ref2, x, y;
// Iterate through image, row by row then pixel by pixel
    for (y = n = 0, ref1 = l_h; (0 <= ref1 ? n < ref1 : n > ref1); y = 0 <= ref1 ? ++n : --n) {
      for (x = o = 0, ref2 = l_w; (0 <= ref2 ? o < ref2 : o > ref2); x = 0 <= ref2 ? ++o : --o) {
        // Grab index of pixel in bot space and canvas space
        bi = x + (y * l_w);
        ci = (x + l_x) + ((y + l_y) * BOARD_WIDTH);
        // Skip transparent pixels
        if (l_imgcc[bi] === 255) {
          continue;
        }
        // Compare image color code to board color code
        // If not equal, send pixel message making it equal,
        // set next iteration, then return
        if (g_board[ci] !== l_imgcc[bi]) {
          ws_send_putPixel(x + l_x, y + l_y, l_imgcc[bi]);
          return l_timeout = window.setTimeout(bot_loop, (RATELIMIT_SEC * 1000) + 50);
        }
      }
    }
    // If we made it here, then all pixels match already
    // Wait a little bit and try again
    return l_timeout = window.setTimeout(bot_loop, 100);
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Stop running the bot and clear all bot-related UI
  bot_cancel = function() {
    // Cancel bot loop
    if (l_timeout != null) {
      window.clearTimeout(l_timeout);
    }
    l_timeout = null;
    // Erase stored data
    l_imgcc = null;
    l_x = l_y = 0;
    l_w = l_h = 0;
    // Show bot icon again
    $('.panel.button.bot').removeClass('cancel');
    // Set canvas size to 0
    $('canvas.bot').prop('width', 0).prop('height', 0);
    // Hide the bot canvas, re-show pixel placement reticule
    $('canvas.bot').addClass('-hidden');
    $('.reticule').removeClass('-hidden');
    // Reset min/max position to restore full movement
    g_pos.setMin().setMax();
    // Switch status appropriately
    switch (g_role) {
      case ADMN:
        return status_set(STATUS_PLACETILE);
      case AUTH:
        if (g_cooldown) {
          return status_set(STATUS_COOLDOWN, g_cooldown);
        } else {
          return status_set(STATUS_PLACETILE);
        }
    }
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Used by admins to insta-place images
  bot_place = function() {
    // Retrieve x,y coords for image top-left
    l_x = g_pos.xf - Math.floor(l_w / 2);
    l_y = g_pos.yf - Math.floor(l_h / 2);
    // Send image placement message
    ws_send_putImage(l_x, l_y, l_w, l_h, l_imgcc);
    // Nothing to do here
    return bot_cancel();
  };

  /////////////////////////////////////////////////////////////////////////////////
  // Animate bot-placement canvas
  bot_animateUI = function() {
    var br, h, offx, offy, tl, w;
    // Grab width and height
    w = $('canvas.bot').prop('width');
    h = $('canvas.bot').prop('height');
    // Determine center offset from top-left so image renders in center
    offx = Math.floor(w / 2);
    offy = Math.floor(h / 2);
    // Retrieve coordinates for top-left and bottom-right

    // If we're actively placing, lock canvas in place
    if (l_timeout != null) {
      tl = canvas_getMouseFromXY(l_x, l_y);
      br = canvas_getMouseFromXY(l_x + l_w, l_y + l_h);
    } else {
      // If we're not actively placing anything, let the user position the canvas
      tl = canvas_getMouseFromXY(g_pos.xf - offx, g_pos.yf - offy);
      br = canvas_getMouseFromXY(g_pos.xf - offx + w, g_pos.yf - offy + h);
    }
    // Position canvas appropriately
    $('canvas.bot').css({
      top: (tl.my - 3) + 'px',
      left: (tl.mx - 3) + 'px',
      width: (br.mx - tl.mx) + 'px',
      height: (br.my - tl.my) + 'px'
    });
    return window.requestAnimationFrame(bot_animateUI);
  };

  //###############################################################################
  // Initialization
  $(function() {
    // Start the bot animation loop
    return window.requestAnimationFrame(bot_animateUI);
  });

  //###############################################################################
  // Event handling
  $(function() {
    /////////////////////////////////////////////////////////////////////////////
    // Click the bot: Begin bot placement flow
    return $('.panel.button.bot').on('click', function(e) {
      var fsel;
      //=======================================================================
      // Step 0: Check for alternate states
      switch (status_get()) {
        //-------------------------------------------------------------------
        // Cancel placement if we're positioning or running the bot
        case STATUS_BOTPOS:
        case STATUS_BOTRUN:
          bot_cancel();
          return false;
      }
      //=======================================================================
      // Step 1: Select an image file

      // Create a new file selection element
      fsel = $("<input type='file' accept='image/png'>");
      // Simulate a click to open file select dialog
      fsel.click();
      // Set callback to run when user selects a file
      return fsel.on('change', async function(e) {
        var canvas_data, cc, img, img_dv, img_rgba, n, ref1, rgba;
        if (!e.target.files.length) {
          bot_cancel();
        }
        //===================================================================
        // Step 2: Process image

        //-------------------------------------------------------------------
        // Decode image

        // TODO error handling
        img = UPNG.decode((await e.target.files[0].arrayBuffer()));
        // Array of color codes for this image, stored for later
        l_imgcc = new Uint8Array(img.width * img.height);
        // Convert image to RGBA values
        img_rgba = UPNG.toRGBA8(img)[0];
        // And get a data view
        img_dv = new DataView(img_rgba);
        // Also store image width and height for later
        l_w = img.width;
        l_h = img.height;
//-------------------------------------------------------------------
// Convert to color codes

        // Loop over all pixels
        for (i = n = 0, ref1 = l_imgcc.length; (0 <= ref1 ? n < ref1 : n > ref1); i = 0 <= ref1 ? ++n : --n) {
          // Get color code for this pixel
          rgba = img_dv.getUint32(i * 4);
          cc = PALETTE_INTS.indexOf(rgba);
          // If this is a valid color, set value appropriately
          if (cc !== -1) {
            l_imgcc[i] = cc;
          } else {
            // If this is an invalid color, set to transparent
            // and treat as if it doesn't exist
            l_imgcc[i] = 0xFF;
            img_dv.setUint32(i * 4, 0x00000000);
          }
        }
        //===================================================================
        // Step 3: Display and position image

        //-------------------------------------------------------------------
        // Position and draw image

        // Set bot canvas properties
        $('canvas.bot').prop('width', img.width).prop('height', img.height);
        // Draw onto image
        // This took a LOT of fiddling to get right
        canvas_data = $('canvas.bot')[0].getContext('2d').getImageData(0, 0, img.width, img.height);
        canvas_data.data.set(new Uint8Array(img_rgba));
        $('canvas.bot')[0].getContext('2d').putImageData(canvas_data, 0, 0);
        //-------------------------------------------------------------------
        // Misc

        // Set min/max position to not draw over the edge
        // TODO +1 seems wrong
        g_pos.setMin(Math.floor(img.width / 2), Math.floor(img.height / 2));
        g_pos.setMax(BOARD_WIDTH - Math.ceil(img.width / 2) + 1, BOARD_HEIGHT - Math.ceil(img.height / 2) + 1);
        // Show canvas, hide pixel placement reticule
        $('canvas.bot').removeClass('-hidden');
        $('.reticule').addClass('-hidden');
        // Display X over bot
        $('.panel.button.bot').addClass('cancel');
        // Set status appropriately
        return status_set(STATUS_BOTPOS);
      });
    });
  });

}).call(this);
</script>
		<style>@font-face{font-family:"Noto Sans";font-weight:normal;src:url("/resources/fonts/NotoSans-Regular.ttf")}@font-face{font-family:"Noto Sans";font-weight:bold;src:url("/resources/fonts/NotoSans-Bold.ttf")}@font-face{font-family:"Noto Sans";font-weight:normal;font-style:italic;src:url("/resources/fonts/NotoSans-Italic.ttf")}@font-face{font-family:"Noto Sans";font-weight:bold;font-style:italic;src:url("/resources/fonts/NotoSans-BoldItalic.ttf")}@font-face{font-family:"Noto Sans Mono";src:url("/resources/fonts/NotoSansMono-VariableFont_wdth,wght.ttf")}.-select-none{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.-select-text{-webkit-touch-callout:text;-webkit-user-select:text;-khtml-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text}.-select-contain{-webkit-touch-callout:contain;-webkit-user-select:contain;-khtml-user-select:contain;-moz-user-select:contain;-ms-user-select:contain;user-select:contain}body{background-color:#333;margin:0;border:0;padding:0;width:100vw;height:100vh;font-size:2vh;font-family:"Noto Sans"}.-hidden{display:none}button{outline:none;border-radius:100vh;border:2px solid #d4d7d9;background:none;background-position:center;background-repeat:no-repeat}button.cancel{background-image:url("/resources/images/cancel.svg")}.panel{position:fixed;z-index:200;background:#fff;box-shadow:0 0 30px #000;border-radius:100vh;color:#000;font-size:90%;text-align:center}.panel.pos-zoom{font-family:"Noto Sans Mono";font-weight:700;top:3vh;left:50vw;transform:translateX(-50%);padding:.25em 1em .25em;width:12em}.panel.status{font-family:"Noto Sans";font-weight:bold;bottom:3vh;left:50vw;transform:translateX(-50%);padding:.25em 1em .25em;width:10em}.panel.status .timeleft{display:inline-block}.panel.status img.timeleft{width:.95em;height:.95em;transform:scale(1.5) translate(-20%, 7%)}.panel.status.wide{width:15em}.panel.button{border-radius:1.5vh;width:6vh;height:6vh;background-repeat:no-repeat;background-position:50% 50%}.panel.button.donate{top:3vh;left:3vh;background-image:url("/resources/images/donate-svgrepo-com.svg");background-size:75%;background-position:55% 50%}.panel.button.about{top:3vh;right:3vh;background-image:url("/resources/images/question-mark-button-svgrepo-com.svg");background-size:75%}.panel.button.settings{top:12vh;right:3vh;background-image:url("/resources/images/gear-svgrepo-com.svg");background-size:70%;background-position:50% 55%}.panel.button.bot{bottom:3vh;left:3vh;background-image:url("/resources/images/bot.svg");background-size:80%;background-position:55% 55%}.panel.button.bot.cancel{background-image:url("/resources/images/cancel.svg");background-size:60%}.panel.button.admin{bottom:12vh;left:3vh;transform:scaleX(-1);background-image:url("/resources/images/gavel-svgrepo-com.svg");background-size:80%}.panel.button.chat{bottom:3vh;right:3vh;background-image:url("/resources/images/chat-svgrepo-com.svg");background-size:80%}.palette{position:fixed;z-index:300;bottom:0vh;left:0;width:100vw;background:#fff;box-shadow:0 0 10px #000;transition:bottom .5s ease-in-out}.palette>div{display:block;padding:1.5vh}.palette .colors{padding-bottom:0;display:grid;grid-template-columns:repeat(16, 1fr);grid-column-gap:.3vh;grid-row-gap:.3vh}@media only screen and (orientation: landscape){.palette .colors{grid-template-columns:repeat(32, 1fr)}}.palette .colors .color{height:3vh;border:1px solid #000}.palette .colors .color.selected{border-color:#fff !important;box-shadow:#000 0px 0px 10px 2px}.palette .buttons{display:flex;height:4vh}.palette .buttons .spacer{flex:1 1 auto}.palette .buttons form{position:relative}.palette .buttons button{width:30vw;height:100%}@media only screen and (orientation: landscape){.palette .buttons button{width:12vw}}.palette .buttons form.cancel button{background-image:url("/resources/images/cancel.svg");background-size:2.5vh;margin-right:3vw}.palette .buttons form.submit button{background-image:url("/resources/images/submit.svg");background-size:3.5vh}.palette .buttons form.submit button:not([disabled]){border-color:#f50;box-shadow:inset 0 0 0 2px #f50,inset -1px 0 0 2px #f50,inset 1px 0 0 2px #f50}.palette.-hidden{display:block;bottom:-20vh}canvas.place{position:fixed;z-index:0;transform-origin:top left;width:500vmin;height:500vmin;top:50vh;left:50vw;image-rendering:pixelated;image-rendering:crisp-edges;outline:1px solid #181818}canvas.place.smooth-animation{transition:transform .5s ease-out}.reticule{position:fixed;z-index:1;pointer-events:none}.reticule img{position:absolute;top:0;left:0;width:100%;height:100%;transform:scale(120%)}canvas.bot{position:fixed;z-index:1;pointer-events:none;image-rendering:pixelated;image-rendering:crisp-edges;outline:3px solid #333;border:3px solid #ccc}.popup-grayout{position:fixed;z-index:1000;top:0;left:0;bottom:0;right:0;width:100vw;height:100vh;background-color:rgba(136,136,136,.6666666667);transition:opacity .5s ease-in-out}.popup-grayout.-hidden{display:block;opacity:0;pointer-events:none}.popup{position:fixed;z-index:1001;top:20vh;height:60vh;left:10vw;width:80vw;background:#fff;border-radius:5vh;transition:top .5s cubic-bezier(0.68, -0.55, 0.27, 1.55)}@media only screen and (orientation: landscape){.popup{left:30vw;width:40vw}}.popup.-hidden{display:block;top:120vh !important}.popup.validate{top:25vh;height:50vh;left:20vw;width:60vw;display:grid;grid-template-rows:auto 10vh}@media only screen and (orientation: landscape){.popup.validate{left:30vw;width:40vw}}.popup.validate .text{padding:5vw}.popup.validate button.cancel{display:block;width:80%;height:5vh;margin:0 auto 5vh}.chat-parent{position:fixed;z-index:200;bottom:3vh;right:3vh;width:calc(100vw - 6vh);height:84vh;background:#fff;border-radius:1.5vh;box-shadow:0 0 30px #000;transition:right .5s ease-in-out;display:grid;grid-template-rows:4vh 60px auto 2.1em;grid-row-gap:.5vh;padding:.5vw}@media only screen and (orientation: landscape){.chat-parent{width:30vw;width:min(33vw,500px)}}.chat-parent .top-bar button.cancel{width:4vh;height:4vh;border-color:#333;background-size:50%}.chat-parent .ad-space{background:blue}.chat-parent .chat-log{overflow:clip scroll;word-wrap:break-word;line-height:110%}.chat-parent .chat-log .msg-group{padding:.3em .3em .5em}.chat-parent .chat-log .msg-group>.user{font-weight:bold}.chat-parent .chat-log .msg-group .msg{margin-top:.25em}.chat-parent .chat-log .msg-group:nth-child(odd){background:#eee}.chat-parent .chat-send input{width:calc(100% - 1em - .6em);height:calc(100% - .4em - .6em);border:none;outline:none;font-size:2vh;margin:none;padding:.2em .5em;box-shadow:0 0 .5em #000;border-radius:.5em;margin:.3em}.chat-parent.-hidden{display:grid;right:-100vw}@media only screen and (orientation: landscape){.chat-parent.-hidden{right:-35vw}}
</style>
	</head>
	<body class="-select-none">
<div class="panel pos-zoom -select-text"></div><div class="panel status"></div><div class="panel button donate"></div><div class="panel button settings -hidden"></div><div class="panel button about"></div><div class="panel button bot -hidden"></div><div class="panel button admin -hidden"></div><div class="panel button chat -hidden"></div><div class="palette -hidden"><div class="colors"></div><div class="buttons"><div class="spacer"></div><form class="cancel"><button></button></form><form class="submit"><button disabled="disabled"></button></form><div class="spacer"></div></div></div><canvas class="place" noselect="noselect" width="2000" height="2000"></canvas><div class="reticule"><img src="/resources/images/select.svg"/></div><canvas class="bot -hidden" noselect="noselect"></canvas><div class="popup-grayout -hidden"></div><div class="popup about -hidden"></div><div class="popup validate -hidden"><div class="text"></div><button class="cancel"></button></div><div class="chat-parent -hidden"><div class="top-bar"><button class="cancel"></button></div><div class="ad-space"></div><div class="chat-log -select-text"></div><form class="chat-send" accept-charset="utf-8"><input type="text" enterkeyhint="send"/></form></div></body>
</html>